# Neo4j 미연결 시 자동 폴백 설명 (비개발자용)

**작성일**: 2026-02-12  
**대상**: 비개발자 이해를 위한 설명

---

## 🎯 핵심 개념

**"에러 핸들링: Neo4j 미연결 시 자동 폴백"**이란?

→ **Neo4j 데이터베이스에 연결할 수 없을 때, 시스템이 자동으로 다른 방법으로 작동하도록 하는 안전장치**

---

## 📖 일상 비유로 이해하기

### 비유 1: 도서관 예약 시스템

**상황**: 책을 빌리려고 도서관에 갔는데, 도서관 컴퓨터가 고장났어요.

**옵션 A (폴백 없음)**: 
- "도서관 컴퓨터 고장났으니 오늘은 책 못 빌려요" → ❌ 서비스 중단

**옵션 B (폴백 있음)**: 
- "도서관 컴퓨터 고장났지만, 수동으로 책 찾아서 빌려드릴게요" → ✅ 서비스 계속

**우리 시스템**: 옵션 B처럼 작동합니다!

---

### 비유 2: 네비게이션 앱

**상황**: 길을 찾으려는데 인터넷이 끊겼어요.

**옵션 A (폴백 없음)**:
- "인터넷 없으니 길 못 찾아요" → ❌ 앱 사용 불가

**옵션 B (폴백 있음)**:
- "인터넷 없지만, 저장된 지도로 길 찾아드릴게요" → ✅ 계속 사용 가능

**우리 시스템**: 옵션 B처럼 작동합니다!

---

## 🔄 실제 시스템 플로우

### 시나리오: 사용자가 감사 독립성 검토를 요청했을 때

```
[사용자] "이 시나리오 분석해줘"
         ↓
[시스템] "이 시나리오를 본 적 있나? Neo4j 데이터베이스 확인해볼게"
         ↓
    ┌─────────────────────────────┐
    │ Neo4j 연결 시도              │
    └─────────────────────────────┘
         ↓
    ┌─────────────────────────────┐
    │ 연결 성공?                   │
    └─────────────────────────────┘
         ↓
    ┌───────┐              ┌──────────┐
    │  예   │              │   아니오  │
    └───────┘              └──────────┘
         ↓                      ↓
[저장된 데이터 찾기]    [폴백: 다른 방법 사용]
         ↓                      ↓
[데이터 있음?]          [AI에게 직접 물어보기]
         ↓                      ↓
    ┌───────┐              ┌──────────┐
    │  예   │              │   아니오  │
    └───────┘              └──────────┘
         ↓                      ↓
[저장된 데이터 사용]    [AI가 새로 분석]
    (빠름, 무료)            (느림, 비용)
         ↓                      ↓
    [결과 제공]
```

---

## 💡 구체적인 예시

### 상황 1: Neo4j 정상 작동

**플로우**:
1. 사용자: "김 회계사는 A회계법인에 소속되어 있고, B회사의 감사를 담당하고 있어요"
2. 시스템: Neo4j 데이터베이스 확인 → "아, 이 시나리오 전에 본 적 있어요!"
3. 시스템: 저장된 분석 결과 사용 (0.01초, 무료)
4. 사용자: 결과 받음 ✅

**결과**: 빠르고, 비용 없음

---

### 상황 2: Neo4j 연결 실패 (폴백 작동)

**플로우**:
1. 사용자: "김 회계사는 A회계법인에 소속되어 있고, B회사의 감사를 담당하고 있어요"
2. 시스템: Neo4j 데이터베이스 확인 시도 → "연결 실패! (서버 꺼짐, 네트워크 문제 등)"
3. 시스템: "괜찮아요, AI에게 직접 물어볼게요" (폴백 작동)
4. 시스템: AI에게 분석 요청 (2초, 비용 발생)
5. 사용자: 결과 받음 ✅

**결과**: 느리지만, 서비스는 계속 작동

---

### 상황 3: Neo4j 연결은 되지만 데이터 없음

**플로우**:
1. 사용자: "새로운 시나리오 분석해줘"
2. 시스템: Neo4j 데이터베이스 확인 → "이 시나리오는 처음 봐요"
3. 시스템: AI에게 분석 요청
4. 시스템: 분석 결과를 Neo4j에 저장 (다음에 빠르게 사용하기 위해)
5. 사용자: 결과 받음 ✅

**결과**: 첫 번째는 느리지만, 다음부터는 빠름

---

## 🛡️ 폴백이 없다면?

### 문제 상황

**폴백 없이 구현했다면**:
```
[사용자] "분석해줘"
         ↓
[시스템] "Neo4j 연결 시도..."
         ↓
[시스템] "연결 실패!"
         ↓
[시스템] "에러 발생! 서비스 중단" ❌
         ↓
[사용자] "왜 안 되죠?" 😢
```

**결과**: Neo4j에 문제만 있어도 전체 서비스가 멈춤

---

### 폴백이 있는 현재 구현

```
[사용자] "분석해줘"
         ↓
[시스템] "Neo4j 연결 시도..."
         ↓
[시스템] "연결 실패! 괜찮아요, 다른 방법 쓸게요"
         ↓
[시스템] "AI에게 직접 물어보는 중..."
         ↓
[사용자] "결과 받음!" ✅
```

**결과**: Neo4j에 문제가 있어도 서비스 계속 작동

---

## 📊 비교표

| 상황 | 폴백 없음 | 폴백 있음 (현재) |
|------|-----------|-----------------|
| **Neo4j 정상** | ✅ 빠르게 작동 | ✅ 빠르게 작동 |
| **Neo4j 연결 실패** | ❌ 서비스 중단 | ✅ 다른 방법으로 작동 |
| **사용자 경험** | 😢 불안정 | 😊 안정적 |
| **서비스 가용성** | 낮음 | 높음 |

---

## 🎯 핵심 메시지

### "자동 폴백"이란?

**의미**: 
- 자동으로 = 사람이 개입하지 않고 시스템이 알아서
- 폴백 = Plan B, 대안 방법

**결과**:
- Neo4j가 작동하지 않아도 서비스는 계속 됩니다
- 사용자는 중단 없이 결과를 받을 수 있습니다
- 다만, 첫 번째 방법(Neo4j)이 더 빠르고 비용이 적습니다

---

## 🔍 코드에서 어떻게 작동하나요?

### 간단한 설명

**코드 위치**: `backend/services/independence_service.py`

```python
def get_independence_map_from_neo4j(trace_id: str):
    try:
        # Neo4j 연결 시도
        with get_neo4j_session() as session:
            # 데이터 조회
            ...
    except Exception:
        # 연결 실패 시 None 반환 (폴백)
        return None
```

**의미**:
- `try`: "Neo4j 연결 시도해볼게"
- `except`: "실패하면 None 반환해" (폴백 신호)
- 호출하는 쪽에서 None을 받으면 → "아, 폴백이구나" → AI에게 직접 요청

---

## ✅ 요약

**"에러 핸들링: Neo4j 미연결 시 자동 폴백"**은:

1. **Neo4j 데이터베이스에 연결할 수 없을 때**
2. **시스템이 자동으로 다른 방법(AI 직접 요청)을 사용하도록 하는**
3. **안전장치**

**결과**: 
- 서비스가 중단되지 않음
- 사용자는 항상 결과를 받을 수 있음
- 다만, Neo4j가 작동하면 더 빠르고 저렴함

**비유**: 도서관 컴퓨터가 고장나도 수동으로 책을 빌려주는 것처럼!
